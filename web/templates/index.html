{% extends 'layout.html' %}

{% block content %}
<div class="card animate-fade">
    <div class="card-title">
        <i class="fas fa-chart-line"></i>
        System Overview
    </div>
    <div class="grid">
        <div class="stat-box">
            <span class="stat-label">CPU Temperature</span>
            <span class="stat-value">{{ "%.1f"|format(health.system_stats.cpu_temp_c) }}°C</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">Uptime</span>
            <span class="stat-value">{{ health.board_info.uptime }}</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">RAM Usage</span>
            <span class="stat-value">{{ health.system_stats.ram.percent }}%</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">GPIO Config</span>
            <span class="stat-value">
                <span title="Inputs" style="font-size: 1.1rem; color: #555;">{{ io_counts.input }} IN</span>
                <span style="color: #ccc; margin: 0 0.5rem;">|</span>
                <span title="Outputs" style="font-size: 1.1rem; color: var(--loxone-green);">{{ io_counts.output }}
                    OUT</span>
            </span>
        </div>
    </div>
</div>

<div class="grid animate-fade" style="margin-top: 2rem;">
    <div class="card">
        <div class="card-title">
            <i class="fas fa-network-wired"></i>
            Active Network
        </div>
        <p><strong>Device:</strong> {{ net_status.ethernet.device if net_status.ethernet.active else
            net_status.wifi.device or 'None' }}</p>
        <p><strong>IP Address:</strong> <span style="color: var(--loxone-green); font-weight: 600;">{{
                net_status.main_ip }}</span></p>
        <div style="margin-top: 1rem;">
            <a href="/network" class="secondary-btn"><button class="secondary">Manage Network</button></a>
        </div>
    </div>

    <div class="card">
        <div class="card-title">
            <i class="fas fa-shield-alt"></i>
            System Status
        </div>
        <p><strong>OS:</strong> {{ health.board_info.os }}</p>
        <p><strong>Kernel:</strong> {{ health.board_info.kernel }}</p>
        <div style="margin-top: 1rem;">
            <a href="/system" class="secondary-btn"><button class="secondary">System Info</button></a>
        </div>
    </div>
</div>

<div class="card animate-fade" style="margin-top: 2rem;">
    <div class="card-title">
        <i class="fas fa-microchip"></i>
        Live Metrics (Last 60 min)
    </div>
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));">
        <div style="height: 250px;">
            <canvas id="tempChart"></canvas>
        </div>
        <div style="height: 250px;">
            <canvas id="loadChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let tempChart, loadChart;

    function initCharts(history) {
        const labels = history.map(d => d.time);
        const temps = history.map(d => d.temp);
        const loads = history.map(d => d.load);

        const ctxTemp = document.getElementById('tempChart').getContext('2d');
        tempChart = new Chart(ctxTemp, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'CPU Temp (°C)',
                    data: temps,
                    borderColor: '#69C350',
                    backgroundColor: 'rgba(105, 195, 80, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: false, grid: { color: '#eee' } },
                    x: {
                        grid: { display: false },
                        ticks: { maxTicksLimit: 6 }
                    }
                }
            }
        });

        const ctxLoad = document.getElementById('loadChart').getContext('2d');
        loadChart = new Chart(ctxLoad, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'CPU Load (1m)',
                    data: loads,
                    borderColor: '#3A4045',
                    backgroundColor: 'rgba(58, 64, 69, 0.05)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: '#eee' } },
                    x: {
                        grid: { display: false },
                        ticks: { maxTicksLimit: 6 }
                    }
                }
            }
        });
    }

    async function updateCharts() {
        try {
            const response = await fetch('/api/stats/history');
            const data = await response.json();
            const history = data.history;

            if (history.length > 0) {
                if (!tempChart) {
                    initCharts(history);
                } else {
                    tempChart.data.labels = history.map(d => d.time);
                    tempChart.data.datasets[0].data = history.map(d => d.temp);
                    tempChart.update('none'); // Update without animation for performance

                    loadChart.data.labels = history.map(d => d.time);
                    loadChart.data.datasets[0].data = history.map(d => d.load);
                    loadChart.update('none');
                }
            }
        } catch (e) {
            console.error("Chart update failed", e);
        }
    }

    // Update every 10 seconds
    setInterval(updateCharts, 10000);
    updateCharts();
</script>
{% endblock %}