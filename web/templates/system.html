{% extends 'layout.html' %}

{% block content %}
<div class="card animate-fade">
    <div class="card-title">
        <i class="fas fa-sync"></i>
        OTA Software Update
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <p><strong>Current Version (Hash):</strong> <code
                    style="background: var(--bg-stat); color: var(--text-main); padding: 0.2rem 0.4rem; border-radius: 4px;">{{ (update_info.local_hash or 'Unknown')[:8] }}</code>
            </p>
            {% if update_info.error %}
            <p style="color: var(--loxio-error); font-size: 0.85rem; margin-top: 0.5rem;">
                <i class="fas fa-exclamation-triangle"></i> Update check failed (Offline?)
            </p>
            {% elif update_info.update_available %}
            <p style="color: var(--loxio-green); font-weight: 600; margin-top: 0.5rem;">
                <i class="fas fa-info-circle"></i> A new update is available!
            </p>
            {% else %}
            <p style="color: var(--text-dim); margin-top: 0.5rem;">Your software is up to date.</p>
            {% endif %}
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button onclick="triggerUpdate(false)" id="update-btn" {{ 'disabled' if not update_info.update_available }}>
                Update Now
            </button>
            <button onclick="triggerUpdate(true)" id="force-update-btn" class="secondary">
                <i class="fas fa-bolt"></i> Force Update
            </button>
        </div>
    </div>

    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
        <p style="font-weight: 600; margin-bottom: 1rem;"><i class="fas fa-file-archive"></i> Manual ZIP Update</p>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1; margin-right: 1rem;">
                <input type="file" id="zip-file" accept=".zip"
                    style="font-size: 0.9rem; color: var(--text-dim); width: 100%;">
                <p style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.7;">
                    Upload a repository ZIP (e.g., from GitHub).
                </p>
            </div>
            <button onclick="uploadZip()" id="upload-btn">
                <i class="fas fa-upload"></i> Upload & Update
            </button>
        </div>
    </div>
</div>

<div class="card animate-fade">
    <div class="card-title">
        <i class="fas fa-power-off"></i>
        Power Controls
    </div>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button onclick="systemControl('reboot')" class="secondary">
            <i class="fas fa-redo"></i> Reboot System
        </button>
        <button onclick="systemControl('shutdown')" class="danger">
            <i class="fas fa-power-off"></i> Shutdown
        </button>
    </div>
    <p style="margin-top: 1rem; font-size: 0.85rem; opacity: 0.7;">
        <i class="fas fa-exclamation-triangle"></i> Warning: Shutdown will require physical access to power-cycle the
        board.
    </p>
</div>

<div class="card animate-fade">
    <div class="card-title">
        <i class="fas fa-file-code"></i>
        Loxone Config Templates
    </div>
    <p style="margin-bottom: 1.5rem; opacity: 0.8;">Download XML templates for one-click import into Loxone Config.</p>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="/loxone/download/inputs" style="text-decoration: none;">
            <button class="secondary"><i class="fas fa-download"></i> Virtual Inputs</button>
        </a>
        <a href="/loxone/download/outputs" style="text-decoration: none;">
            <button class="secondary"><i class="fas fa-download"></i> Virtual Outputs</button>
        </a>
        <a href="/loxone/download/stats" style="text-decoration: none;">
            <button class="secondary"><i class="fas fa-download"></i> System Stats</button>
        </a>
    </div>
</div>

<div class="card animate-fade">
    <div class="card-title">
        <i class="fas fa-file-alt"></i>
        System Logs
    </div>
    <div id="logs-container"
        style="background: #1e1e1e; color: #d4d4d4; padding: 1.5rem; border-radius: 8px; font-family: 'Courier New', Courier, monospace; font-size: 0.85rem; height: 400px; overflow-y: scroll;">
        Loading logs...
    </div>
    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
        <button class="secondary" onclick="refreshLogs()"><i class="fas fa-sync"></i> Refresh Now</button>
        <button class="active" id="live-log-btn" onclick="toggleLiveLogs(this)">Stop Live Logs</button>
    </div>
</div>

<script>
    async function triggerUpdate(force = false) {
        const msg = force
            ? "Are you sure you want to FORCE update? This will re-download and reinstall even if up to date."
            : "Are you sure you want to update? The system will restart.";
        if (!confirm(msg)) return;

        const btn = force ? document.getElementById('force-update-btn') : document.getElementById('update-btn');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Updating...";

        try {
            const url = force ? '/api/update/ota?force=true' : '/api/update/ota';
            const response = await fetch(url, { method: 'POST' });
            const result = await response.json();
            if (result.error) {
                alert("Update failed: " + result.error);
                btn.disabled = false;
                btn.innerText = originalText;
            } else {
                alert("Update initiated. The system will be back in about 60 seconds.");
            }
        } catch (e) {
            alert("Update trigger failed.");
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    async function uploadZip() {
        const fileInput = document.getElementById('zip-file');
        if (!fileInput.files.length) {
            alert("Please select a ZIP file first.");
            return;
        }

        if (!confirm("Are you sure you want to upload and update from this ZIP file?")) return;

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        const btn = document.getElementById('upload-btn');
        btn.disabled = true;
        btn.innerText = "Uploading...";

        try {
            const response = await fetch('/api/update/zip', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            alert("ZIP uploaded successfully. Update is running. The system will restart.");
        } catch (e) {
            console.error(e);
            alert("Upload failed.");
        } finally {
            btn.disabled = false;
            btn.innerText = "Upload & Update";
        }
    }

    async function systemControl(type) {
        const msg = type === 'reboot' ? "Are you sure you want to REBOOT the system?" : "Are you sure you want to SHUTDOWN the system?";
        if (!confirm(msg)) return;

        try {
            const response = await fetch(`/api/system/${type}`, { method: 'POST' });
            const result = await response.json();
            alert(result.message + ". The connection will be lost.");
        } catch (e) {
            alert("Operation failed. The device might be already restarting.");
        }
    }

    let logInterval = null;

    async function refreshLogs() {
        const container = document.getElementById('logs-container');
        try {
            const response = await fetch("/api/logs?lines=200");
            const data = await response.json();

            if (data.logs && Array.isArray(data.logs)) {
                // Parse and colorize logs
                const colorized = data.logs.map(line => {
                    let className = 'log-info';
                    if (line.includes(' - ERROR - ')) className = 'log-error';
                    else if (line.includes(' - WARNING - ')) className = 'log-warning';

                    // Simple regex to pull out parts if we want more detail later
                    // Format: 2026-01-29 20:25:34,123 - LoxIO - INFO - Message
                    return `<div class="${className}">${line}</div>`;
                }).join("");

                container.innerHTML = colorized;

                // Only scroll if already at bottom (optional feature, here we just scroll)
                container.scrollTop = container.scrollHeight;
            }
        } catch (e) {
            container.innerText = "Error loading logs.";
        }
    }

    function toggleLiveLogs(btn) {
        if (logInterval) {
            clearInterval(logInterval);
            logInterval = null;
            btn.classList.add('secondary');
            btn.classList.remove('active');
            btn.innerText = "Resume Live Logs";
        } else {
            refreshLogs();
            logInterval = setInterval(refreshLogs, 5000);
            btn.classList.remove('secondary');
            btn.classList.add('active');
            btn.innerText = "Stop Live Logs";
        }
    }

    // Initial load and start live
    refreshLogs();
    logInterval = setInterval(refreshLogs, 5000);
</script>
{% endblock %}